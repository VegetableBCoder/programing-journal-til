# 类文件结构

* jvm不与Java语言绑定, 而是与class文件绑定, 也就是说只要能编译出字规范的节码文件, 也就能运行在JVM上
* Class文件采用类似于C语言结构体的伪结构来存储数据, 编码方式为Big-Endian

## 结构

* Class文件是连续的字节流, 没空隙, 所以所以其存储的顺序都是严格定义的
  * 对于长度不定的属性, 会使用先存储一个元素数量N 再连续存储N个元素的方式
* 基础类型是无符号数, 有1,2,4,8字节长度的无符号数
* 表是由多个无符号数或者表作为数据项构成的复合数据类型

| 类型           | 属性               | 数量                 |
| -------------- | ------------------ | -------------------- |
| u4             | magic              | 1                    |
| u2             | minor_version      | 1                    |
| u2             | major_version      | 1                    |
| u2             | constant_pool_size | 1                    |
| cp_info        | constant_pool      | constant_pool_size-1 |
| u2             | access_flag        | 1                    |
| u2             | this_class         | 1                    |
| u2             | super_class        | 1                    |
| u2             | interfaces_count   | 1                    |
| u2             | interfaces         | interfaces_count     |
| u2             | fields_count       | 1                    |
| field_info     | fields             | fields_count         |
| u2             | methods_count      | 1                    |
| method_info    | methods            | methods_count        |
| u2             | attributes_count   | 1                    |
| attribute_info | attributes         | attributes_count     |

### 魔数

* 固定为 0xCAFEBABE, JVM可以读取前4个字节快速过滤掉不是类文件的文件

### 版本号

* 主版本号: 高版本的JVM可以兼容低版本的class, 但是不能运行更新版本的类文件
* 次版本号: JDK1, 1.1 使用; JDK1.2起固定为0; JDK12起用于标识技术预览功能支持
  * 如果类使用了未列入正式特性清单的功能，必须将次版本设置为65535

### 常量池

* 常量池容量不是固定的, 所以需要先说明其数量
  * 常量池是从下标1开始索引的, 下标0没有使用, 考量是某些特殊情况下需要表示不引用任何一个常量池成员
* 常量分为两类: 字面常量和符号引用
  * 字面量接近Java语言的常量定义: 如字符串, 数字等
  * 符号引用则是编译原理上的概念, 如被模块导出的或者开放的包, 类/接口的全名, 方法的名称和描述符, 字段的名称和描述符,方法句柄和方法类型, 动态调用点和动态常量
* 由于JVM使用动态连接的原因, 字段/方法的符号引用需要放在常量池中, 再在类创建时解析, 翻译到对应到具体的内存地址中

### 访问信息

* 标识这是类还是接口, 是否是抽象的, 是否是final的, 权限修饰符是public/private等

### 类索引(this_class)和父类索引, 接口索引

 * 类索引用于确定这个类的完全限定名, 父类索引用于确定父类的完全限定名, interfaces表示类实现了哪些接口

### 字段表

* 列出全部属性的访问标识, 类型, 是实例类型还是类变量, 并发可见性能否序列化

### 方法表

* 类似于字段表, 列出方法的 访问标志, 名称索引, 描述符索引, 参数表

### 属性表

* class文件, 字段表, 方法表都可以携带自己的属性表
* jvm规范不要求严格有序, 运行时忽略不认识的部分
* JVM规范初版只规定了9种属性表, 目前已经有30+种

<br/>

* 虚拟机规范定义的部分属性, 除了列举的部分, 还有泛型信息, 签名信息, 源文件信息等

| 属性名          | 使用位置       | 含义                            |
| --------------- | -------------- | ------------------------------- |
| Code            | 方法表         | 代码编译出的字节码              |
| ConstantValue表 | 字段表         | final关键字定义的常量值         |
| Deprecated      | 类, 方法, 属性 | 声明为deprecated的类,方法,字段  |
| Exceptions      | 方法           | 方法可能会抛出的异常            |
| EnColsingMethod | 类文件         | 表示局部类/匿名类所在的外围方法 |
| InnerClass      | 类文件         | 内部类列表                      |
|...|


