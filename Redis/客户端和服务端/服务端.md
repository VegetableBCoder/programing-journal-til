# 服务端

## 请求执行的完整流程

* 客户端发送命令
* 服务端读出请求内容. 选择命令执行器
* 命令执行器查找命令实现方式(redisCommand)
* 命令执行器执行预备操作
  * cmd指针指向null说明命令无法实现, 返回错误信息
  * 检查参数个数是否正确
  * 检查用户身份
  * 检查内存是否足够
  * 检查命令标识
* 命令执行器调用实现的命令函数
* 命令执行器执行后续工作
  * 慢查询日志记录
  * 修改命令的执行次数, 执行总耗时
  * AOF缓冲区写入
  * 从节点的命令复制传播
* 回复客户端执行结果


### redisCommand的组成

| 字段      | 类型              | 作用                                                   |
| --------- | ----------------- | ------------------------------------------------------ |
| name      | char*             | 命令名称, 如set                                        |
| proc      | redisCommandProc* | 指向实现函数的指针                                     |
| arity     | int               | 参数个数, 用于检查格式是否正确, 负数n则说明参数个数>=n |
| flags     | int               | 命令的标志信息                                         |
| sflags    | char*             | 字符串形式的flags                                      |
| calls     | long long         | 这个命令被执行的次数                                   |
| millsocod | long long         | 执行这个命令总共消耗的时长                             |



### sflags详解

| 表示 | 含义                                                             | 带有这个标识的命令   |
| ---- | ---------------------------------------------------------------- | -------------------- |
| w    | 这是写入命令, 会修改数据库内容                                   | SET/RPUSH/DEL等      |
| r    | 这是读取命令, 不会修改数据库                                     | GET HGET等           |
| m    | 可能会占用大量内存的命令, 执行前需要检查内存情况或禁止执行此命令 | SET/APPEND/RPUSH等   |
| a    | 这是一个管理命令                                                 | SAVE/BGSAVE等        |
| p    | 这是一个订阅相关命令                                             | PUBLISH/SUBSCRIBEd等 |
| s    | 命令不能在lua脚本中使用                                          | BRPOP/BLPOP等        |
| R    | 随机命令, 相同状态下执行返回的结果可能不同                       | SPOP/SRANDMEMBER等   |
| S    | Lua脚本中执行这个命令时, 对输出结果进行排序, 使得命令结果有序    | SINTER/SUNION等      |
| l    | 这个命令可以在服务器载入数据的过程中使用                         | INFO/PUBLISH等       |
| t    | 这个数土匪他也不需要从服务器在带有过期数据时使用的命令           | SLAVEOF/PING/INFO等  |
| M    | 这个命令在监视器模式下不会被自动传播                             | EXEC                     |

## 时间事件的执行

* 通过serverCron执行
* 更新时间缓存
  * 为了减少系统调用. unixtime和unixmstime都是缓存的
* 更新LRU时钟
  * 更新服务器的lru时间, 每10s一次, 计算时与对象的lrulock想减即可
* 更新服务器的CPS
  * 100ms一次, 估算服务器最近1s执行的命令条数
* 更新服务器的内存峰值记录
* 处理SIGTERM信号
  * 执行关闭前的RDB导出和停服
* 执行clientsCron, 检查客户端是否已经超时
  * 输入缓冲区长度检查
* databaseCron: 过期键删除, 字典收缩等
* 执行被延迟的BGREWRITEAOF

 