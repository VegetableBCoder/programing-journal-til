# AOF持久化

## 实现方式

### 命令追加

* 执行命令后将写命令追加到aof_buf的末尾

### 文件写入&同步

* 服务器结束事件循环时(完成一轮文件事件处理和时间事件处理的调用)调用flushAppendOnlyFile函数
* appendfsync的影响
  * always: 将aof_buf的全部内容写入到操作系统缓冲区并同步到AOF文件
    * 安全性最高, 效率最低, 仅可能丢失一个事件循环的数据
  * eversync: 将aof_buf的内容写入到操作系统缓冲区, 如果距离上一次同步超过1s则同步到文件
    * 安全性较高, 仅可能丢失1s的数据
  * no: 仅将aof_buf写入缓冲区, 缓冲区同步到磁盘由操作系统决定
    * 安全性较低, 可能 丢失上一次同发布之后的数据

## AOF重写

* 随着redis的运行, 命令越来越多, AOF文件需要瘦身

### 实现方式

* 维护一个BGREWRITEAOF缓冲区, 这个缓冲区将会记录执行BGREWRITEAOF期间执行的心命令
* 重新生成还原当前数据库状态的必须命令
* 执行完毕后将缓冲区的命令追加在新的AOF文件末尾

