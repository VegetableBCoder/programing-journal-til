# Redis 数据结构 SDS

```c
struct sdshdr {
    // 已使用的长度, 但不含\0 即字符串的长度
    int len;
    // buf中未使用的部分长度
    int free;
    // 保存字符串内容的数组
    char buf[];
}
```

## 相对于C字符串的改进

* C字符串不记录自己的长度, 获取字符串需要遍历数组直到读到\0为止, 复杂度为O(n), 而SDS记录了真实长度, 复杂度只需O(1)
* 通过预分配空间减少内容变化时的内存重新分配次数
  * 由于buf中有长度为free的空间未使用, 如果修改字符串为长度len+free以内的内容无需重新分配内存
* 惰性空间释放
  * 如果将字符串长度修改为长度小于len的字符串, 多余的空间将会留给下次修改备用, 而不是立即释放掉, SDS也提供了方法回收这些空间
* 不以\0为结尾标记, 使内容可以包含\0字符, 对二进制内容友好
* C字符串在操作时没有预检查空间是否足够, 比如strcat将一个字符串拼接到林一个字符串上, 如果被拼接的空间不够, 就会出现错误


