 # 整数集合

* 当集合键的元素不多, 并且都是整数类型时, redis会使用整数集合来减少空间占用
* 整数集合可以保存int16_t, int32_t, int64_t的整数集合

 ## 实现

```c
 typedef struct  intset{
    // 编码方式
    uint32_t encoding;
    // 集合元素数量
    uint32_t length;
    int8_t contents[];
 } intset;
```

### 详解

* 根据encoding的不同, 确定如何一个集合成员占用contents中的几个数字
* 数组的长度为 集合长度 * 集合中每个元素的字节数

## 整数集合的升级

* 定义: 将一个元素添加到整数集合时, 如果比现有类型的长度都要长时, 需要先升级, 再将数字添加到集合中
  * 如原来的数都是16位编码的数字, 将65536添加到集合中就需要升级为32位编码
* 操作过程
  * 根据新加入的元素类型, 扩展底层数组空间, 为新元素分配空间
  * 将所有现有元素转换为新元素的类型, 并将转换后的元素放在正确位置上, 位置有序性不变
  * 将新的元素添加到数组中
    * 新的元素要么比所有元素都大, 要么都小, 所以要么在集合的左边, 要么在集合的右边

