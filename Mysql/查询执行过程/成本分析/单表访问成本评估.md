# 单表访问成本评估

## 成本构成

* 成本主要分为两块: IO成本和CPU成本
  * IO成本主要只从磁盘或缓存中读取页的成本
  * CPU成本主要是判断一行数据是否符合查询条件的成本

## 成本常数设定

* 加载一个页面: 1.0
* 读取一条记录, 判断是否符合查询条件: 0.2
* 举例分析过程中忽略mysql的成本修正值(影响非常小, 远低于索引的影响)


## 评估方式

* 找出可能使用的二级索引
* 计算全表扫描的成本
* 评估使用各二级索引和全表扫描的成本, 取最低的一种方式

## 分析

### 数据准备

* 有表t, 有索引 idx_t_a(a), 唯一索引 uk_t_b(b), 索引 idx_t_c(c), 联合索引 id_t_p1_p2_p3(p1, p2, p3)
* 执行查询
  ```sql
  select * 
  from t 
  where a in ('a','b','c') 
  and b > 10 and b < 100
  and c > b
  and p1 like '%xxx%'
  and f1 = 'xxx'
  ``` 
* 假设有数据10000条

### 可以使用的二级索引分析

* 条件a in ('a','b','c') 
  * 可以使用idx_t_a索引, 按照range方式查询
* 条件 b>10 and b <100
  * 使用uk_t_b索引, 按照range方式查询
* 条件 c > b, 无法确定扫描边界, 不能使用idx_t_c索引
* 条件p1 like '%xxx%', 无法确定索引的扫描边界, 不能使用idx_t_p1_p2_p3
* 条件 f1='xxx', 没有索引可用

### 全表扫描的成本评估

* 全表扫描代价的评估需要两个关键参数: 聚簇索引的页面数, 表的记录数, 可以通过show table status看到
  * 对于Innodb而言统计值中的data_length就是聚簇索引的大小, 现在假设这个大小是1638400
  * 表的记录数在innodb中没有一个精准的统计值, 这个值是一个近似的估计值, 现在假设这个近似值是9800
* 计算可得 聚簇索引的页面数是100 (1638400/1024/16)
* 计算可得IO成本为 100 * 1.0 =100
* 计算可得CPU成本为 9800 * 0.2  =1960
* 总成本为2060

### 计算使用不同二级索引的成本

#### 使用唯一索引 uk_t_b的成本计算

* 确定扫描区间为 (10, 100)
* 二级索引成本IO计算
  * 无论扫描的区间占用多少个页面, 优化器总是认为一个扫描区间的IO成本与读取一个页面的IO成本相同
* 二级索引的CPU计算需要先确定扫描区间内有多少条记录
  * 如果区间起始位置和结束位置不超过10个页面, 则Mysql会精确计算扫描的记录数
  * 如果超过十个页面会按照区间左边的十个页面记录数平均值*间隔的页面数
    * 确定间隔页面数通过计算父节点的间隔数来实现
* 现在假设唯一索引uk_t_b在10到100的范围内有20条数据
* 可以计算读取20行数据的成本为20*0.2=4
* 读取到二级索引的数据之后还需要回表, 计算在聚簇索引上的IO成本和CPU成本开销
  * Mysql的优化器认为每一次回表查询都需要访问一个页面, 也就是说二级索引扫描到多少条记录就会访问多少次页面
* 可以计算回表的IO开销为 20 * 1, CPU开销为 20*0.2
* 总成本为 1 + 20 * 0.2 + 20 * 1 + 20 * 0.2 = 29

### 使用普通索引 idx_t_a的成本

* 确定扫描区间为三个单点区间 [a, a], [b, b], [c, c]
* 按照mysql的评估规则二级索引的IO成本为3
* 假设有满足 a in ('a','b','c') 的数据有200条, 二级索引记录读取成本为 200*0.2 =40
* 回表IO成本 200*1=200, 回表CPU成本 200 * 0.2 =40
* 总成本 243

### 索引合并情况考虑

* 由于可能的两个二级索引查询的都不是一个单点区间, 不是严格有序的, 所以不满足Intesection规则
  * Mariadb的Sort-Intersection在这里不讨论

### 结论

* 唯一索引uk_t_b的成本为最低值29, 所以使用该索引进行查询


## 延伸 二级索引成本分析的优化

* in 查询 相当于多个不连续的单点区间, 如果in的太多, 在计算这些单点区间的性能开销会消耗比较大
* mysql提供了一个系统环境变量eq_range_index_dive_limit, 默认值200
* 区间个数小于这个配置值时, mysql会按照上文提到的方式计算这些区间内的记录条数
* 大于这个数时, mysql将会使用索引的统计数据来估算这些区间的记录条数