# 索引条件下推(ICP)

> 下推指的是将原来由SQL层负责判断的条件交给存储引擎层

## 条件

* 使用二级索引进行查询
* 没有使用索引覆盖, 即需要回表
* 需要下推判断的条件不影响索引扫描的边界

## 案例分析

> 有表t, 有组合所有idx_a_b_c(a,b,c)
> 有查询 select * from t where a=1 and b>1 and c>1

### 无ICP的执行情况

* 1 SQL层按照a=1 and b>1的条件确定扫描范围: 从a=1, b=1的最后一条数据之后到a>1的第一条数据之间
* 2 存储引擎层按照确定的扫描范围扫描数据并交给SQL层处理
* 2.1 取一条二级索引数据, 获取主键值
* 2.2 回表查询行内容, 返回这一行给SQL层
* 2.3 SQL层判断数据是否符合条件c>1, 如果符合返回这一行给用户, 不符合则跳过
* 2.4 按照二级索引页的next_record找到下一条数据, 继续执行2.1, 2.2, 2.3
* 3 查询结束

### ICP的执行情况

* 1 SQL层按照a=1 and b>1的条件确定扫描范围: 从a=1, b=1的最后一条数据之后到a>1的第一条数据之间
* 2 存储引擎层按照确定的范围扫描数据并交给SQL层处理
* 2.1 取一条二级索引数据, 判断其是否符合条件c>1
* 2.2 如果符合条件则回表取数据交给SQL层, 如果不符合则按照next_record扫下一条二级索引记录
* 2.3 SQL层返回数据给用户
* 3 查询结束