# 行格式

## COMPACT格式

### 数据结构

| 组成部分         | 说明                     | 备注                                   |
| ---------------- | ------------------------ | -------------------------------------- |
| 变长字段长度列表 | 记录所有变长字段的长度   | 长度与可变长度字段数量有关, 顺序是倒序 |
| NULL值列表       | 记录了哪些字段的值为null | 顺序是逆序的                           |
| 记录头信息       | 行记录的元数据信息       | 固定5字节                              |
| 数据             | 存储用户数据的部分       |                                        |

### 记录头信息的内容

| 字段         | 长度(bit) | 用途                     | 备注                                                   |
| ------------ | --------- | ------------------------ | ------------------------------------------------------ |
| 预留位       | 2         |                          | 未使用                                                 |
| delete_flag  | 1         | 行删除标记               |                                                        |
| min_rec_flag | 1         | 最小记录标记             | B+树非叶子节点才有                                     |
| n_owned      | 4         | 记录所属槽的记录条数     | 每个槽最大的一条记录才有值                             |
| heap_no      | 13        | 当前记录在页面堆中的位置 |                                                        |
| record_type  | 3         | 记录类型                 | 0: 叶节点记录 1: 非叶结点目录项 2: Infimum 3: Supremum |
| next_record  | 16        | 下一条记录的位置         | 相对位置                                               |

### char(M) 处理

* 如果字符集是订长字符集(如ASCII), 则该字段视为定长字段
* 如果字符集是变长字符集(如UTF-8), 则盖子段视为变长字段

## REDUNDANT格式

### 数据结构

| 组成部分     | 说明               | 备注                           |
| ------------ | ------------------ | ------------------------------ |
| 字段偏移列表 | 每列的偏移位置     | 相邻两列偏移量的差就是字段长度 |
| 记录头信息   | 行记录的元数据信息 | 固定6字节                      |

### 记录头信息的内容

| 字段            | 长度(bit) | 用途                                 | 备注                       |
| --------------- | --------- | ------------------------------------ | -------------------------- |
| 预留位          | 2         |                                      | 未使用                     |
| delete_flag     | 1         | 行删除标记                           |                            |
| min_rec_flag    | 1         | 最小记录标记                         | B+树非叶子节点才有         |
| n_owned         | 4         | 记录所属槽的记录条数                 | 每个槽最大的一条记录才有值 |
| heap_no         | 13        | 当前记录在页面堆中的位置             |                            |
| n_field         | 10        | 10                                   | 记录的列数                 |
| 1byte_offs_flag | 1         | 标记偏移量的地址长度是1字节还是2字节 |
| next_record     | 16        | 下一条记录的位置                     | 绝对位置                   |

### char(M) 处理

* 字段的固定长度为 M * 当前字符集一个字符的最大长度

## DYNAMIC

* 与COMPACT的不同点在于溢出列的处理
  * COMPACT/REDUNDANT: 在行记录页存储768字节+20字节记录在其他页面的地址长度信息, 存不下的丢到溢出页
  * DYNAMIC: 行内不记录前768字节, 只记录20字节的溢出页地址信息

## COMPRESSED

* 基于DYNAMIC加页面压缩算法