# Innodb页

* Innodb以页为基本单位进行存储空间管理，一页的大小一般为16KB
* Innodb页的类型可以有很多种, 比如用于存储数据的索引页, 存放表空间信息的的页, 存放ChangeBuffer的页, 存放INODE信息的页, 存放各种日志的页

## 索引页结构

| 字段           | 含义     | 长度 | 说明       | 备注     |
| -------------- | -------- | ---- | ---------- | -------- |
| File Header    | 文件头   | 38B  | 页通用信息 |          |
| Page Header    | 页头     | 56B  | 索引页信息 |          |
| Infimum        | 最小记录 | 13B  | 最小记录   | 虚拟记录 |
| Supremum       | 最大记录 | 13B  | 最大记录   | 虚拟记录 |
| User Records   | 用户数据 | 不定 |            |          |
| Free Space     | 空闲空间 | 不定 |            |          |
| Page Directory | 页目录   | 不定 |            |          |
| File Trailer   | 文件尾   | 8B   | 完整性校验 |          |

### 页目录的结构

* 页目录可以视为一个页内的数据索引
* 首先把页内的数据分成多个组, 称为槽, 槽的数量记录到页头上
  * Infimum单独一个组
  * Supremum所在组可以有1-8条数据
  * 其他组在4-8条之间
* 把每个组的最大记录作为本组的代表, 在这一条记录的n_owned上记录这一组的记录条数
* 把每个组作为代表这条记录的偏移量提取出来, 记录到页尾, 称为页目录
* 通过索引找到定位到索引页之后, 可以通过页目录较快的检索到数据
  
### 页头的数据结构

| 字段名称          | 空间大小 | 内容                                           |
| ----------------- | -------- | ---------------------------------------------- |
| PAGE_N_DIR_SLOTS  | 2字节    | 页内划分为多少个槽                             |
| PAGE_HEAP_TOP     | 2字节    | 空闲空间地址起点                               |
| PAGE_N_HEAP       | 2字节    | 第1位标识是否紧凑型记录, 剩余15位表示记录条数  |
| PAGE_FREE         | 2字节    | 垃圾链表的链表头                               |
| PAGE_GARBAGE      | 2字节    | 已删除的数据占用空间大小                       |
| PAGE_LAST_INSERT  | 2字节    | 最后一条插入数据的位置                         |
| PAGE_DIRECTION    | 2字节    | 记录插入的方向                                 |
| PAGE_N_DIRECTION  | 2字节    | 沿一个方向连续插入的记录条数                   |
| PAGE_N_RECS       | 2字节    | 未删除的用户记录条数                           |
| PAGE_MAX_TRX_ID   | 8字节    | 修改当前页的最大事务id, 聚簇索引没有这个字段   |
| PAGE_LEVEL        | 2字节    | 页所在的B+树层级                               |
| PAGE_INDEX_ID     | 8字节    | 页所属的索引id                                 |
| PAGE_BTR_SEG_LEAF | 10字节   | B+树叶子节点的头部信息, 仅根节点存在这个字段   |
| PAGE_BTR_SEG_TOP  | 10字节   | B+树非叶子节点的头部信息, 仅根节点存在这个字段 |


### File Header的数据结构

| 字段名称          | 空间大小 | 内容                                           |
| ----------------- | -------- | ---------------------------------------------- |
| FILE_CHECKSUM |4B | 校验和 |
| FILE_PAGE_OFFSET | 4B | 页号 |
| FILE_PAGE_PREV | 4B | 上一个页的页号 |
| FILE_PAGE_NEXT | 4B | 下一个页的页号 |
| FILE_PAGE_LSN | 8B | 页面最后被修改时的日志号 |
| FILE_PAGE_TYPE | 2B | 页的类型 |
| FILE_PAGE_FILE_FLUSH_LSN | 8B | 系统表空间的第一个页中才有 |
| FILE_SPACE_ID | 4B | 属于哪个表空间 |

### 文件首尾的校验和

* 我们可以注意到文件头有4byte校验, 文件尾有8B校验和
* 文件尾的前四byte校验和与文件头的校验和在正常情况下是完全一致的
* 如果在文件写入磁盘过程中发生了断电, 前后的校验和就会不一致
* 文件尾后四位和文件头的LSN的后四位是对应的, 也用于完整性校验

